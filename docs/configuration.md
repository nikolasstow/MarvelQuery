# Configuration Options

## Initialization: `MarvelQuery.init()`

The `init` function initializes the MarvelQuery library with your API keys and configuration settings. It returns the `query` function, ensuring that no queries can be created without proper initialization. The function has two arguments, the public and private keys for the Marvel API, and configuration options detailed below.

```ts
const query = MarvelQuery.init({
    publicKey: "your-public-key",
    privateKey: "your-private-key",
  }, {
    // Configuration options...
  });
```

## `APIKeys`

| Property     | Type     | Description            |
| ------------ | -------- | ---------------------- |
| `publicKey`  | `string` | Marvel API public key  |
| `privateKey` | `string` | Marvel API private key |

## `Config`: Configuration Options

| Property               | Type                                      | Description                                                  |
| ---------------------- | ----------------------------------------- | ------------------------------------------------------------ |
| `autoQuery`            | `boolean`                                 | Enables/disables [AutoQuery Injection](autoquery.md).     |
| `globalParams`         | [`GlobalParams`](#globalparams-1)           | Global parameters to be applied to all queries, or all queries of a specific type. |
| `onResult`             | [`OnResultMap`](#onresultmap)             | A map of functions to be called when all results, or results of a specific type, are returned. |
| `onRequest`            | ` (url: string) => void`                  | A function that is called for each request. Useful for monitoring your API usage. |
| `logOptions`           | [`LogOptions`](#logoptions-1)               | Options for logging, including verbosity, max length in console, and options for saving to file. |
| `httpClient`           | [`HTTPClient`](#httpclient-1)            | Replace the default fetch function (axios) with your own HTTP client. |
| `validation`           | [`ValidationOptions`](#validationoptions) | Enables or disables validation at various stages of the query process, including parameter validation, API response validation, and AutoQuery injections. |
| `showHiddenProperties` | `boolean`                                 | Properties that pertain to the response of the API are hidden by default until a response is received. In some situations you may want to disable this feature. [Learn more here.](#showhiddenproperties-boolean) |

## Configuration Options and Examples

### `autoQuerty` (`boolean`)

AutoQuery Injection, when enabled, automatically injects properties and methods into every part of the API response that contains a URI to another resource or collection. This allows for seamless chaining of queries without manually constructing new requests. 

For example, when querying for a character, the API response will include URIs for related resources such as comics, series, or events. With AutoQuery enabled, these URIs are transformed into queryable methods. You can then easily chain additional queries from the response, like so:

```ts
query('characters', {
  name: "Peter Parker"
}).fetchSingle()
.then(character => character.comics.query().fetch());
```

In this example, the character.comics.query() method is automatically generated by the autoQuery feature, making it easy to fetch related comics for the character. If autoQuery is disabled, the response will not include these injected methods, and you would need to manually create new queries for related resources.

### `globalParams`

Set global parameters during initialization and they will be applied to all queries. Set globals on a type-by-type basis, or set globals that apply to every query.

```ts
const query = MarvelQuery.init({ ... }, {
  globalParams: { // Global parameters
    all: { // Applies to all queries
      limit: 10,
    },
    comics: { // Applies to all queries of type 'comics'
      noVariants: true,
    },
  },
});
```

### `onRequest`

Provide a custom function that runs on every request, receiving the URL, endpoint, and parameters of that request. This allows you to track your API usage or perform additional actions with the request data.

```ts
const query = MarvelQuery.init({ ... }, {
  onRequest: (url, endpoint, params) => {
    console.log(`Requesting ${url}`);
    console.log(`Endpoint:`, endpoint);
    console.log(`Parameters:`, params);
  }
});
```

### `onResult`

Configure functions to run whenever a result of any type or of a specific type is returned by the API.

```ts
const query = MarvelQuery.init({ ... }, {
  onResult: {
    any: (data) => console.log(data),
    comics: (comics) => {
      comics.map((comic) => {
        console.log("Saving comic:", comic.title);
      })
    }
  }
});
```

### `logOptions`

Set `verbose` to true to get extensive logging with details for debugging. Configure amount of lines and line lengths for messages logged in the console. Messages will be truncated only in the console, and the full message can be found in the log files.

```ts
const query = MarvelQuery.init({ ... }, {
	verbose: true,
  saveToFile: true,
  // Truncate long messages in the console
  maxLines: 23,
	maxLineLength: 500,
});
```

### `httpClient`

Replace the default http client with one of your choosing, implement your own strategy for caching and de-duping. No limits, do things the way you like them, MarvelQuery won't stand in your way.

```ts
// In this example we'll use the axios package, but you can use whichever http client you prefer.

// Map to store ongoing requests for de-duping
const cache = new Map<string, Promise<any>>();

const query = MarvelQuery.init({ ... }, {
  // Global parameters
  httpClient: (url: string): Promise<unknown> => {
    if (cache.has(url)) return cache.get(url)!;
  
    const promise = new Promise<unknown>((resolve, reject) => {
      const timeout = setTimeout(() => reject(new Error('Timeout')), 5000);
  
      axios.get(url).then((response) => {
        clearTimeout(timeout);
        resolve(response.data);
      }).catch((error) => {
        clearTimeout(timeout);
        reject(error);
      }).finally(() => {
        cache.delete(url);
      });
    });
  
    cache.set(url, promise);
    return promise;
  }
});
```

### `showHiddenProperties` (`boolean`)

By default, the library hides certain properties on query instances that are empty before an API response is fetched. These include properties like the result array, count, total, and others that aren’t populated until a fetch operation is completed. Once the fetch() method is called, the returned instance will have these properties visible and populated.

```ts
const peter = query('characters', { name: "Peter Parker" });
const parker = peter.fetch();

// Technically, peter and parker are the same instance, yet your linter will likely disagree
```

Even though peter and parker refer to the same instance, tools like linters may raise a warning or error when comparing them, because the hidden properties are not visible on peter before the fetch occurs. The IDE might think those properties don’t exist on peter, but they are actually there, just hidden.

Enabling `showHiddenProperties` will always make these properties visible, even before the fetch() call. This ensures that the linter and IDE are aware of the full shape of the object, making them “happy.” However, be aware that the properties will be visible but empty until a fetch populates them.

## Types

### `GlobalParams`

The globalParams feature in your library enables you to set default parameters for API queries, streamlining requests and ensuring consistency across different endpoints. By defining these parameters globally, you eliminate redundancy and ensure that specific criteria are consistently applied unless explicitly overridden in individual queries.

| Property     | Type                                                   | Description                                                  |
| ------------ | ------------------------------------------------------ | ------------------------------------------------------------ |
| `all`        | [`APIBaseParams`](api-parameters.md#base-parameters)     | Parameters which apply to all requests, and as such are limited to parameters found on all endpoints (`modifiedSince`, `limit`, and `offset`). |
| `comics`     | [`ComicParams`](api-parameters.md#comicparams)         | Set default parameters for all api requests for comics.      |
| `characters` | [`CharacterParams`](api-parameters.md#characterparams) | Set default parameters for all api requests for characters . |
| `creators`   | [`CreatorParams`](api-parameters.md#creatorparams)     | Set default parameters for all api requests for creators.    |
| `events`     | [`EventParams`](api-parameters.md#eventparams)         | Set default parameters for all api requests for events.      |
| `stories`    | [`StoryParams`](api-parameters.md#storyparams)         | Set default parameters for all api requests for stories.     |
| `series`     | [`SeriesParams`](api-parameters.md#seriesparams)       | Set default parameters for all api requests for series.      |

### `OnResultMap`

| Property     | Type                                                     | Description                                                  |
| ------------ | -------------------------------------------------------- | ------------------------------------------------------------ |
| `any`        | [`OnResultFunction<AnyType>`](#onresultfunction)         | A function that will be called when a query of any type is finished, unless overridden by a specific onResult function for a particular type. |
| `comics`     | [`OnResultFunction<MarvelComic>`](#onresultfunction)     | A function that will be called when comic results are returned from the API, passing an array of Marvel comics. |
| `characters` | [`OnResultFunction<MarvelCharacter>`](#onresultfunction) | A function that will be called when character results are returned from the API, passing an array of Marvel characters. |
| `creators`   | [`OnResultFunction<MarvelCreator>`](#onresultfunction)   | A function that will be called when creator results are returned from the API, passing an array of Marvel creators. |
| `events`     | [`OnResultFunction<MarvelEvent>`](#onresultfunction)     | A function that will be called when event results are returned from the API, passing an array of Marvel events. |
| `stories`    | [`OnResultFunction<MarvelStory>`](#onresultfunction)     | A function that will be called when story results are returned from the API, passing an array of Marvel stories. |
| `series`     | [`OnResultFunction<MarvelSeries>`](#onresultfunction)    | A function that will be called when series results are returned from the API, passing an array of Marvel series. |

### `LogOptions`

 `logOptions`  allows you to configure the logging behavior of the library, providing control over verbosity, log formatting, and file management:

- **`verbose` (boolean)**: Enable or disable verbose logging for detailed output during operations.
- **`maxLines` (number)**: Set the maximum number of lines in a single log message (console only).
- **`maxLineLength` (number)**: Set the maximum character length for each line in a log message (console only).
- **`saveToFile` (boolean)**: Enable or disable saving logs to files for persistent storage.
- **`maxFileSize` (string)**: Define the maximum size for a log file, in bytes (e.g., `"10MB"`).
- **`maxFiles` (string)**: Specify the maximum number of log files to retain, or the number of days to keep logs using a suffix like `'d'` (e.g., `"14d"` for 14 days).

This gives you full control over the logging details, from the level of verbosity to file storage management.

```ts
interface LogOptions {
  verbose?: boolean;
  maxLines?: number;
  maxLineLength?: number;
  saveToFile?: boolean;
  maxFileSize?: string;
  maxFiles?: string;
}
```

### `HTTPClient`

```ts
/**
 * Replace the default HTTP client with one of your choosing.
 * 
 * Function type definition:
 */
type HTTPClient = (url: string) => Promise<unknown>;
/** 
 * Default function:
 */
(url) => axios.get(url).then((response) => response.data);
```

### `ValidationOptions`

The `validation` option allows you to configure different validation behaviors in the library, ensuring data integrity and preventing invalid inputs or API responses. You can fine-tune validation at various stages of the query lifecycle with the following options:

- **`disableAll` (boolean)**: Globally enable or disable all validators. When set to `true`, no validation will occur at any stage.
- **`parameters` (boolean)**: Enable or disable validation of query parameters. This ensures that the parameters passed to the API are valid according to the expected schema.
- **`apiResponse` (boolean)**: Enable or disable validation of API responses. This checks the data returned by the API to ensure it conforms to expected types and structures.
- **`autoQuery` (boolean)**: Enable or disable validation of AutoQuery injections (if AutoQuery is enabled). This ensures that any properties or methods automatically injected into the response data are validated.

By default, all validators are enabled, but you can customize these settings based on your specific needs.

```ts
interface ValidationOptions {
  disableAll?: boolean;
  parameters?: boolean;
  apiResponse?: boolean;
  autoQuery?: boolean;
}
```

### `OnResultFunction`

```ts
/**
 * Type of function that will be called when the query is finished, 
 * passing the results as an array.
 */
type OnResultFunction<R extends MarvelResult> = (
  data: R[]
) => void | Promise<unknown>;
```

### `AnyType`

```ts
/**
 * A union type of all Marvel data types.
 */
type AnyType = MarvelComic | MarvelCharacter | MarvelCreator | MarvelEvent | MarvelSeries | MarvelStory;
```

### `OnRequestFunction`

```ts
/**
 * OnRequestFunction is a callback type that is invoked for each request made.
 * It receives the request URL, endpoint, and query parameters.
 */
type OnRequestFunction = (
  url: string,
  endpoint: Endpoint,
  params: Record<string, unknown>
) => void;
```
